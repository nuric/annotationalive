{% extends "main_base.html" %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" integrity="sha256-Ndk1ry+oGNFEaXt4kxlW/SYLbxat1O0DhaDd+lob0SY=" crossorigin="anonymous" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha256-BZ71u1P7NUocEN9mKkcAovn3q5JPm/r9xVyjWh/Kqrc=" crossorigin="anonymous" />
<style>
.markdown-body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
}
@media (max-width: 767px) {
  .markdown-body {
    padding: 15px;
  }
}
</style>
{% endblock %}

{% block navbar %}
<button class="w3-bar-item w3-button w3-padding-large" onclick="openTab('md_source')">Source</button>
<button class="w3-bar-item w3-button w3-padding-large" onclick="openTab('md_out')">Rendered</button>
<button class="w3-bar-item w3-button w3-padding-large" onclick="toggleAutoScroll(this)">AutoScroll</button>
<button class="w3-bar-item w3-button w3-padding-large" onclick="elementPrint('md_out')">Print</button>
{% endblock %}

{% block content %}
<div id="docapp"> <!-- Vue Wrapper for doc application -->
    <div class="w3-row-padding">
      <div id="md_source" class="w3-card w3-white w3-padding tab" style="display:none">
        <textarea v-model="doc" style="width:100%;height:80vh;max-width:100%" {% if current_user.id != doc.user_id %}readonly{% endif %}>
        </textarea>
      </div>
      <div id="md_out" v-html="renderedDoc" class="w3-card w3-white w3-padding tab markdown-body" style="margin-bottom:100px">
      </div>
    </div>
</div> <!-- End Vue Wrapper -->
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.4.2/markdown-it.min.js" integrity="sha256-JdPG0DllQPmyIeUeYRUCvk6K3tY7C7RZyVKEcT56yzQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha256-q01RVaHUJiYq9aq0FwkI6GAmMtOmRgToK8aEHHm4Xl8=" crossorigin="anonymous"></script>
<script>
// Basic tab functionality
function openTab(tabid) {
    var tabs = document.getElementsByClassName("tab");
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].style.display = "none"; 
    }
    document.getElementById(tabid).style.display = "block"; 
}

// Print functionality
// https://stackoverflow.com/questions/12997123/print-specific-part-of-webpage
function elementPrint(id) {
  var prtContent = document.getElementById(id);
  var WinPrint = window.open('', '', 'left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0');
  WinPrint.document.write('<html><head>');
  WinPrint.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" integrity="sha256-Ndk1ry+oGNFEaXt4kxlW/SYLbxat1O0DhaDd+lob0SY=" crossorigin="anonymous" />');
  WinPrint.document.write('<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github.min.css">');
  WinPrint.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha256-BZ71u1P7NUocEN9mKkcAovn3q5JPm/r9xVyjWh/Kqrc=" crossorigin="anonymous" />');
  WinPrint.document.write('</head><body class="markdown-body">');
  WinPrint.document.write(prtContent.innerHTML);
  // Standard printing gives blank page, we need to wait for window to render
  WinPrint.document.write("</body>\x3Cscript>window.onload = window.print;\x3C/script></html>");
  WinPrint.document.close();
  WinPrint.focus();
  //WinPrint.print();
  //WinPrint.close();
}

// Markdown renderer
const md = markdownit({
  // Syntax highligthing
  highlight: function (str, lang) {
    if (lang && hljs.getLanguage(lang)) {
      try {
        return hljs.highlight(lang, str).value;
      } catch (__) {}
    }

    return ''; // use external default escaping
  }
});

// Katex math support
(function() {
// Default katex options
kopts = { displayMode: true };
// Setup rendering rules
const defaultRender = md.renderer.rules.text,
      blockmathRE   = /\$\$[^\$]*\$\$/g,
      inlinemathRE  = /\$[^\$]*\$/g;
// Override default rendering function
md.renderer.rules.text = function (tokens, idx, options, env, self) {
  var content = tokens[idx].content;
  // Check for block math first
  if (blockmathRE.test(content)) {
    return content.replace(blockmathRE, (s) => katex.renderToString(s.substring(2, s.length-2), kopts));
  }
  // Check for inline math
  if (inlinemathRE.test(content)) {
    return content.replace(inlinemathRE, (s) => katex.renderToString(s.substring(1, s.length-1)));
  }
  // pass token to default renderer.
  return defaultRender(tokens, idx, options, env, self);
};
})();

// Setup Vue dynamic components
const docapp = new Vue({
  el: '#docapp',
  data: {
    doc: "",
    isIdle: true,
    autoscroll: false,
  },
  // Computed properties
  computed: {
    renderedDoc: function() {
      if (this.autoscroll) {
        this.$nextTick(function() {
          var container = document.getElementById("main_content");
          window.scroll({top: container.scrollHeight, behavior: 'smooth'});
        });
      }
      return md.render(this.doc);
    }
  },
  {% if current_user.id == doc.user_id %}
  // Setup document updates
  created: function() {
    this.debouncedUpdateDoc = _.debounce(this.updateDoc, 500);
  },
  watch: {
    doc: function() {
      this.isIdle = false;
      this.debouncedUpdateDoc();
    }
  },
  // Event handlers
  methods: {
    updateDoc: function() {
      socket.emit('document', this.doc);
      this.isIdle = true;
    }
  }
  {% endif %}
});

// Basic autoscroll
function toggleAutoScroll(el) {
  el.classList.toggle("w3-red");
  docapp.autoscroll = !docapp.autoscroll;
}

// Base sets up socket connection
// Update entire document
socket.on('document', function(content) {
  if (docapp.isIdle) {
    docapp.doc = content;
  }
});
</script>
{% endblock %}
